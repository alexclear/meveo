<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:p="http://primefaces.org/ui" xmlns:o="http://omnifaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:hftl="http://hftl.org"
	xmlns:hf="http://java.sun.com/jsf/composite/tags"
	template="/layout/template.xhtml">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView"
				listener="#{customerAccountBean.preRenderView}" />
			<f:viewParam name="customerAccountId"
				value="#{customerAccountBean.objectId}" />
			<f:viewParam name="customerId"
				value="#{customerAccountBean.customerId}" />
			<f:viewParam name="customerId" value="#{customerBean.objectId}" />
		</f:metadata>
	</ui:define>

	<ui:define name="navigation">
		<ui:include src="/layout/navigation.xhtml" />
	</ui:define>

	<ui:define name="body">

		<hftl:entityPopup id="searchCustomerPopup"
			header="#{messages['customer.popup.header']}"
			backingBean="#{customerBean}"
			searchField1Label="#{messages['customer.code']}" searchField1="code"
			column1Label="#{messages['customer.code']}" column1="code"
			selection="#{customerAccountBean.entity.customer}"
			updateField=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:customerSelectId:customerSelectId">
		</hftl:entityPopup>

		<hftl:entityPopup id="customerAccCurrencyPopup"
			header="#{messages['customerAccountCurrencyPopup.header']}"
			backingBean="#{tradingCurrencyBean}"
			searchField1Label="#{messages['businessEntity.code']}"
			searchField1="currencyCode"
			column1Label="#{messages['businessEntity.code']}"
			column1="currencyCode"
			column2Label="#{messages['businessEntity.description']}"
			column2="prDescription"
			selection="#{customerAccountBean.entity.tradingCurrency}"
			updateField=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:currencySelectId:currencySelectId">
		</hftl:entityPopup>

		<p:panelGrid styleClass="col2-set">
			<p:row>
				<p:column styleClass="col1">
					<hf:hierarchyPanel
						treeValue="#{customerTreeBean.buildAccountsHierarchy(customerAccountBean.entity)}"
						entity="#{customerAccountBean.entity}" />
				</p:column>
				<p:column styleClass="col2 tab-view-container">
					<p:tabView id="parentTab"
						activeIndex="#{customerAccountBean.selectedTab}">
						<p:tab id="compte"
							title="#{messages['customerAccount.tab.account']}">
							<hf:formPanel id="formCustomerAccountPanel"
								formId="formCustomerAccount"
								label="#{messages['customerAccount.form']}"
								backingBean="#{customerAccountBean}" showFormButtons="false"
								useCustomIdParam="true" killConversationOnSave="false"
								killConversationOnBack="false">
								<p:panel>
									<p:tabView id="childTab">
										<p:tab id="accountTab"
											title="#{messages['customerAccount.tab.account']}">
											<hftl:panelGroup columns="1">
												<hf:formEntityField id="customerSelectId"
													label="#{messages['customerAccount.customer']}"
													field="customer" childField="code" required="true"
													popup="true" popupId="searchCustomerPopup" />
											</hftl:panelGroup>
											<hftl:panelGroup columns="2">
												<hf:formField label="#{messages['businessEntity.code']}"
													field="code" maxlength="35" validateUnique="true"
													required="true" />
												<hf:formEntityField
													label="#{messages['accountEntity.primaryContact']}"
													field="primaryContact" childField="code"
													listBean="#{providerContactBean}" />
											</hftl:panelGroup>
											<hftl:panelGroup columns="1">
												<hf:formField
													label="#{messages['businessEntity.description']}"
													field="description" id="description" maxlength="100" />
											</hftl:panelGroup>
											<hftl:panelGroup columns="2">
												<hf:formField
													label="#{messages['customerAccount.externalRef1']}"
													field="externalRef1" maxlength="50" />
												<hf:formField
													label="#{messages['customerAccount.externalRef2']}"
													field="externalRef2" maxlength="50" />
												<hf:formEntityField id="currencySelectId"
													label="#{messages['currency.codeCurrency']}"
													required="true" field="tradingCurrency"
													childField="currencyCode" popup="true"
													popupId="customerAccCurrencyPopup" />
											</hftl:panelGroup>
											<hftl:panelGroup columns="2">
												<p:panelGrid columns="2"
													rendered="#{!customerAccountBean.edit}">
													<p:outputLabel for="dunning_text"
														value="#{messages['customerAccount.dunningLevel']}" />
													<h:outputText id="dunning_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.entity.getDunningLevel()}"
														style="font-weight:bold;" />
												</p:panelGrid>
												<hf:emtyFormField />
												<p:panelGrid columns="2"
													rendered="#{!customerAccountBean.edit}">
													<p:outputLabel for="balance_text"
														value="#{messages['customerAccount.balanceDue']}" />
													<h:outputText id="balance_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.getBalanceDue()}"
														style="font-weight:bold;" converter="bigDecimalConverter" />
												</p:panelGrid>
												<p:panelGrid columns="2"
													rendered="#{!customerAccountBean.edit}">
													<p:outputLabel for="balanceEx_text"
														value="#{messages['customerAccount.balanceExigible']}" />
													<h:outputText id="balanceEx_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.getBalanceExigibleWithoutLitigation()}"
														style="font-weight:bold;" converter="bigDecimalConverter" />
												</p:panelGrid>
											</hftl:panelGroup>
											<hftl:panelGroup columns="2">
												<p:panelGrid columns="2">
													<p:outputLabel for="title_text"
														value="#{messages['name.title']}" />
													<p:selectOneMenu id="title_text"
														value="#{customerAccountBean.entity.name.title}"
														required="false" rendered="#{customerAccountBean.edit}"
														converter="omnifaces.SelectItemsConverter">
														<f:selectItem itemLabel="" itemValue="" />
														<f:selectItems value="#{titleBean.listAll()}" var="t"
															itemLabel="#{messages['Title.'.concat(t.code)]}" />
														<p:ajax event="valueChange"
															update=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:countryPanel :parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:userNamePanel" />
													</p:selectOneMenu>
													<h:outputText rendered="#{!customerAccountBean.edit}"
														value="#{messages['Title.'.concat(customerAccountBean.entity.name.title.code)]}"
														style="font-weight:bold;" />
												</p:panelGrid>

												<p:panelGrid id="userNamePanel" columns="2"
													columnClasses="twoColGrid">
													<hf:formEntityField label="#{messages['name.lastName']}"
														field="name" childField="lastName" popup="false"
														maxlength="50" required="true" />
													<p:panelGrid columns="2"
														rendered="#{customerAccountBean.entity.name.title == null or !customerAccountBean.entity.name.title.isCompany}">
														<p:outputLabel for="firstName_text"
															value="#{messages['name.firstName']}" />

														<p:inputText id="firstName_text"
															value="#{customerAccountBean.entity.name.firstName}"
															rendered="#{(customerAccountBean.entity.name.title == null or !customerAccountBean.entity.name.title.isCompany) and customerAccountBean.edit}" />
														<h:outputText
															value="#{customerAccountBean.entity.name.firstName}"
															rendered="#{(customerAccountBean.entity.name.title == null or !customerAccountBean.entity.name.title.isCompany) and !customerAccountBean.edit}"
															style="font-weight:bold;" />
													</p:panelGrid>
													<hf:emtyFormField
														show="#{customerAccountBean.entity.name.title == null or !customerAccountBean.entity.name.title.isCompany}" />
												</p:panelGrid>

											</hftl:panelGroup>

											<hftl:panelGroup columns="2">
												<hf:formField
													label="#{messages['customerAccount.paymentMethod']}"
													field="paymentMethod" childField="label" isMessage="true" />
												<hf:formField
													label="#{messages['customerAccount.creditCategory']}"
													field="creditCategory" childField="label" isMessage="true" />
											</hftl:panelGroup>

											<hftl:panelGroup columns="1">
												<hf:formField label="#{messages['customerAccount.status']}"
													field="status" childField="label" isMessage="true"
													disabled="true" />
											</hftl:panelGroup>
											<hftl:panelGroup columns="1">
												<hf:formField
													label="#{messages['accountEntity.defaultLevel']}"
													field="defaultLevel" isMessage="true" />
											</hftl:panelGroup>
										</p:tab>

										<p:tab id="informationTab"
											title="#{messages['customerAccount.tab.information']}">
											<hftl:fieldset name="#{messages['commons.contacts']}"
												columns="1">
												<hf:formEntityField
													label="#{messages['contactInformation.email']}"
													field="contactInformation" childField="email" popup="false"
													required="false" id="email" maxlength="100"
													validateEmail="true" />
												<hftl:panelGroup columns="2">
													<hf:formEntityField
														label="#{messages['contactInformation.phone']}"
														field="contactInformation" childField="phone"
														popup="false" maxlength="15" />
													<hf:formEntityField
														label="#{messages['contactInformation.mobile']}"
														field="contactInformation" childField="mobile"
														popup="false" maxlength="15" />
												</hftl:panelGroup>
											</hftl:fieldset>
											<hftl:fieldset name="#{messages['commons.address']}"
												columns="1">
												<hftl:panelGroup columns="1">
													<hf:formEntityField label="#{messages['address.address1']}"
														field="address" id="address1" childField="address1"
														popup="false" size="80" maxlength="80" />
													<hf:formEntityField label="#{messages['address.address2']}"
														field="address" id="address2" childField="address2"
														popup="false" size="80" maxlength="80" />
													<hf:formEntityField label="#{messages['address.address3']}"
														field="address" id="address3" childField="address3"
														popup="false" size="80" maxlength="80" />
												</hftl:panelGroup>
												<hftl:panelGroup columns="2">
													<hf:formEntityField label="#{messages['address.zipCode']}"
														size="5" id="zipCode" field="address" childField="zipCode"
														length="3" popup="false" maxlength="5" />
													<hf:formEntityField label="#{messages['address.city']}"
														id="city" field="address" childField="city" popup="false"
														maxlength="50" />
												</hftl:panelGroup>
												<hf:formEntityField id="countryPanel"
													label="#{messages['address.country']}" embedded="true"
													field="address" childField="country"
													labelField="descriptionEn" valueField="countryCode"
													listBean="#{countryBean}"></hf:formEntityField>
											</hftl:fieldset>
											<hftl:fieldset
												name="#{messages['customerAccount.sepaDebit']}" columns="1">
												<hftl:panelGroup columns="1">
													<hf:formField
														label="#{messages['customerAccount.mandateIdentification']}"
														field="mandateIdentification" />
													<hf:formField
														label="#{messages['customerAccount.mandateDate']}"
														field="mandateDate" isDate="true" />
												</hftl:panelGroup>
											</hftl:fieldset>
										</p:tab>
									</p:tabView>

									<hf:formButtons columns="4" saveId="save_2"
										backingBean="#{customerAccountBean}"
										edit="#{customerAccountBean.edit}" ajaxSubmit="false"
										killConversationOnSave="false" killConversationOnBack="false"
										useCustomIdParam="true">
										<p:commandButton
											rendered="#{customerAccountBean.isActiveAccount() and !customerAccountBean.edit}"
											action="#{customerAccountBean.closeCustomerAccount}"
											value="#{messages['customerAccount.buttonCloseAccount']}"
											onclick="if(confirm('#{messages['customerAccount.confirmCloseAccount']}')){return true;}else{return false;}">
											<!-- 										<f:attribute name="backView" value="#{backView}" /> -->
										</p:commandButton>
										<p:button
											rendered="#{customerAccountBean.isActiveAccount() and !customerAccountBean.edit}"
											outcome="addBillingAccount"
											value="#{messages['customerAccount.buttonAddBillingAccount']}">
											<f:param name="cid" value="#{conversation.id}" />
										</p:button>
									</hf:formButtons>
								</p:panel>
							</hf:formPanel>
						</p:tab>
						<p:tab id="ops" title="#{messages['customerAccount.operations']}">
							<hf:searchPanel renderNewButton="false"
								label="#{messages['accountOperation.search']}" columns="1"
								backingBean="#{accountOperationBean}" ajax="true"
								ajaxUpdateIds=":parentTab:results_panel">
								<hftl:panelGroup columns="2">
									<hf:searchField
										label="#{messages['accountOperation.transactionCategory']}"
										field="transactionCategory" />
									<hf:searchField
										label="#{messages['accountOperation.matchingStatus']}"
										field="matchingStatus" />
									<hf:searchField label="#{messages['accountOperation.occCode']}"
										field="occCode" />
									<hf:searchField
										label="#{messages['accountOperation.accountCode']}"
										field="accountCode" />
								</hftl:panelGroup>
								<hf:searchField
									label="#{messages['accountOperation.transactionDate']}"
									field="transactionDate" />
								<hf:searchField label="#{messages['accountOperation.dueDate']}"
									field="dueDate" />
							</hf:searchPanel>
							<br />
							<h:form id="addOperationForm">
								<p:panelGrid columns="3" styleClass="form-panel-actions">
									<p:button value="#{messages['customerAccount.addOperation']}"
										outcome="addNewOperation"
										rendered="#{customerAccountBean.isActiveAccount()}"
										includeViewParams="true">
										<f:param name="cid" value="#{conversation.id}" />
									</p:button>
									<p:commandButton
										value="#{messages['customerAccount.addPaymentCheck']}"
										action="#{otherCreditAndChargeBean.loadFromTemplatePaymentCheck(customerAccountBean.entity.id)}"
										rendered="#{customerAccountBean.isActiveAccount()}" />
									<p:button outcome="transferAccount"
										value="#{messages['customerAccount.buttonTransfert']}"
										rendered="#{customerAccountBean.isActiveAccount()}">
										<f:param name="objectId"
											value="#{customerAccountBean.entity.id}" />
										<f:param name="cid" value="#{conversation.id}" />
									</p:button>
								</p:panelGrid>
							</h:form>

							<hftl:dataList backingBean="#{accountOperationBean}"
								label="#{messages['accountOperation.title']}" disabled="true"
								checkMany="true">

								<p:column style="width:8%">
									<f:facet name="header">
										<h:outputText value="#{messages['accountOperation.type']}" />
									</f:facet>
									<h:outputText value="#{entity.type}" />
								</p:column>

								<p:column style="width:10%">
									<f:facet name="header">
										<h:outputText value="#{messages['accountOperation.occCode']}" />
									</f:facet>
									<h:outputText value="#{entity.occCode}" />
								</p:column>

								<p:column style="width:20%">
									<f:facet name="header">
										<h:outputText
											value="#{messages['accountOperation.occDescription']}" />
									</f:facet>
									<h:outputText value="#{entity.occDescription}" />
								</p:column>

								<p:column style="width:20%">
									<f:facet name="header">
										<h:outputText
											value="#{messages['accountOperation.transactionDate']}" />
									</f:facet>
									<h:outputText value="#{entity.transactionDate}" />
								</p:column>

								<p:column style="width:20%">
									<f:facet name="header">
										<h:outputText value="#{messages['accountOperation.dueDate']}" />
									</f:facet>
									<h:outputText value="#{entity.dueDate}" />
								</p:column>

								<hftl:column label="#{messages['accountOperation.debit']}"
									field="amount"
									show="#{entity.transactionCategory.toString() == 'DEBIT'}"
									converterParam="4digits" />

								<hftl:column label="#{messages['accountOperation.credit']}"
									field="amount"
									show="#{entity.transactionCategory.toString() == 'CREDIT'}"
									converterParam="4digits" />

								<hftl:column
									label="#{messages['accountOperation.unMatchingAmount']}"
									field="unMatchingAmount" converterParam="4digits" />

								<hftl:column
									label="#{messages['accountOperation.matchingStatus']}"
									field="matchingStatus" childField="label" isMessage="true" />

								<hftl:actionsColumn
									editView="#{accountOperationBean.displayOperation(entity.getId())}" />

								<ui:define name="add-on-buttons">
									<p:panelGrid columns="2" styleClass="form-panel-actions">
										<p:commandButton
											action="#{accountOperationBean.matching(customerAccountBean.entity.id)}"
											value="#{messages['customerAccount.buttonLettrage']}"
											rendered="#{customerAccountBean.isActiveAccount()}" />
										<p:commandButton
											action="#{accountOperationBean.consultMatching(customerAccountBean.entity.id)}"
											value="#{messages['customerAccount.buttonConsultMatching']}"
											rendered="#{customerAccountBean.isActiveAccount()}" />
									</p:panelGrid>
								</ui:define>
							</hftl:dataList>

							<h:form>
								<hf:formButtons columns="3" backingBean="#{customerAccountBean}"
									edit="#{customerAccountBean.edit}" ajaxSubmit="false"
									killConversationOnSave="false" killConversationOnBack="false"
									useCustomIdParam="true">
								</hf:formButtons>
							</h:form>
						</p:tab>
					</p:tabView>

				</p:column>
			</p:row>
		</p:panelGrid>
	</ui:define>
</ui:composition>
