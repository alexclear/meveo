<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

    <changeSet id="#1821_20160711" author="EdwardLegaspi">
		<insert tableName="adm_permission">
			<column name="id" value="17" />
			<column name="name" value="Marketing Catalog"></column>
			<column name="ressource" value="marketing"></column>
			<column name="permission" value="marketingCatalogManager"></column>
		</insert>
		
		<sql>ALTER SEQUENCE adm_permission_seq RESTART WITH 18</sql>   
	</changeSet>

	<changeSet id="#1839_20160720_add_marketing_manager_role"
		author="EdwardPLegaspi">
		<insert tableName="adm_role">
			<column name="id" value="5"></column>
			<column name="version" value="0"></column>
			<column name="role_description" value="Marketing "></column>
			<column name="role_name" value="MARKETING_MANAGER"></column>
			<column name="provider_id" value="1"></column>
		</insert>
		
		<sql>ALTER SEQUENCE adm_role_seq RESTART WITH 6;</sql>
		
		 <insert tableName="adm_role_permission">
            <column name="role_id" valueNumeric="5" />
            <column name="permission_id" valueNumeric="17" />
        </insert>
        
        <insert tableName="adm_user">
            <column name="id" valueNumeric="3" />
            <column name="version" valueNumeric="0" />
            <column name="disabled" valueBoolean="false" />
            <column name="created" valueDate="2015-03-19 00:04:09.787" />
            <column name="email" />
            <column name="last_password_modification" valueDate="current_date" />
            <column name="firstname" />
            <column name="lastname" />
            <column name="password" value="c9b9580d19c8cc4f3a83d222a72444a5fc8f0084" />
            <column name="username" value="MEVEO.MARKETINGMANAGER" />
            <column name="provider_id" valueNumeric="1" />
            <column name="title_id" />
        </insert>
        <insert tableName="adm_user_role">
            <column name="user_id" valueNumeric="3" />
            <column name="role_id" valueNumeric="5" />
        </insert>        
        
        <sql>ALTER SEQUENCE adm_user_seq RESTART WITH 4;</sql>
	</changeSet>
    
    <changeSet id="#1844_20160722_orders" author="AndriusKarpavicius">
    
        <insert tableName="adm_permission">
            <column name="id" valueNumeric="18" />
            <column name="name" value="Orders visualization" />
            <column name="permission" value="orderVisualization" />
            <column name="ressource" value="order" />
        </insert>
        <insert tableName="adm_permission">
            <column name="id" valueNumeric="19" />
            <column name="name" value="Order management" />
            <column name="permission" value="orderManagement" />
            <column name="ressource" value="order" />
        </insert>    
        
        <sql>ALTER SEQUENCE adm_permission_seq RESTART WITH 20</sql>   

        <insert tableName="adm_role_permission">
            <column name="role_id" valueNumeric="1" />
            <column name="permission_id" valueNumeric="18" />
        </insert>
        <insert tableName="adm_role_permission">
            <column name="role_id" valueNumeric="1" />
            <column name="permission_id" valueNumeric="19" />
        </insert>        
    </changeSet>

    <changeSet id="#1861_20160817" author="pbach">
        <sql>
            INSERT INTO wf_decision_rule (id, version, disabled, created, updated, condition_el, name, type, value, provider_id, creator_id, updater_id, model) VALUES (1, 0, false, '2016-08-12 21:02:31.26', NULL, '#{mv:getCFValue(entity,"Territory")==_VALUE_}', 'Territory', 'STRING', 'Other', 1, 1, NULL, true);
            INSERT INTO wf_decision_rule (id, version, disabled, created, updated, condition_el, name, type, value, provider_id, creator_id, updater_id, model) VALUES (2, 0, false, '2016-08-13 22:43:06.214', NULL, '#{mv:getCFValue(entity,"Territory")==_VALUE_}', 'Territory', 'STRING', 'south', 1, 1, NULL, false);
            INSERT INTO wf_decision_rule (id, version, disabled, created, updated, condition_el, name, type, value, provider_id, creator_id, updater_id, model) VALUES (3, 0, false, '2016-08-13 22:43:06.214', NULL, '#{mv:getCFValue(entity,"Territory")==_VALUE_}', 'Territory', 'STRING', 'west', 1, 1, NULL, false);
            INSERT INTO wf_decision_rule (id, version, disabled, created, updated, condition_el, name, type, value, provider_id, creator_id, updater_id, model) VALUES (4, 0, false, '2016-08-13 22:52:44.007', NULL, '#{mv:getCFValue(entity,"Territory")==_VALUE_}', 'Territory', 'STRING', 'north', 1, 1, NULL, false);
            INSERT INTO wf_decision_rule (id, version, disabled, created, updated, condition_el, name, type, value, provider_id, creator_id, updater_id, model) VALUES (5, 0, false, '2016-08-15 08:09:43.616', NULL, '#{mv:getCFValue(entity,"SalesAmount")==_VALUE_}', 'Sales amount', 'RANGE_NUMBER', 'Other', 1, 1, NULL, true);
            INSERT INTO wf_decision_rule (id, version, disabled, created, updated, condition_el, name, type, value, provider_id, creator_id, updater_id, model) VALUES (8, 0, false, '2016-08-16 07:46:20.404', NULL, '#{mv:getCFValue(entity,"AccountType")==_VALUE_}', 'Account Type', 'STRING', 'Other', 1, 1, NULL, true);
            ALTER SEQUENCE wf_decision_rule_seq RESTART WITH 10;
        </sql>
    </changeSet>

    <changeSet id="#1839_20160901" author="AndriusKarpavicius">
        <insert tableName="adm_role_permission">
            <column name="role_id" valueNumeric="5" />
            <column name="permission_id" valueNumeric="13" />
        </insert>
    </changeSet>
    
    <changeSet id="#1849_20160909" author="LuisMance">
    	<sql>
            <![CDATA[INSERT INTO dwh_measurable_quant (id, version, disabled, created, updated, code, description, editable, measurement_period, sql_query, provider_id, creator_id, additive) VALUES (nextval('dwh_measurable_quant_seq'), 0, false, '2016-09-09 09:36:00.00', '2016-09-09 09:36:00.00', 'CHURN2', 'Churn', false, 'MONTHLY', 'WITH acc_new AS(SELECT  count(ua.id) as nb FROM billing_user_account ua JOIN account_entity ae ON ae.id=ua.id WHERE ua.subscription_date >= "#{date}" AND ua.subscription_date < "#{nextDate}" AND (ua.termination_date IS NULL OR ua.termination_date >= "#{nextDate}")AND ae.provider_id = #{provider}),acc_end AS(SELECT  count(ua.id) as nb FROM billing_user_account ua JOIN account_entity ae ON ae.id=ua.id WHERE ua.termination_date >= "#{date}" AND ua.termination_date < "#{nextDate}" AND ae.provider_id = #{provider}),acc_period AS(SELECT  count(ua.id) as nb FROM billing_user_account ua JOIN account_entity ae ON ae.id=ua.id WHERE ua.subscription_date < "#{date}" AND  (ua.termination_date IS NULL  OR ua.termination_date>="#{nextDate}") AND ae.provider_id = #{provider}) SELECT CASE  WHEN (acc_period.nb+(acc_new.nb+acc_end.nb)/2) <> 0 THEN acc_end.nb/(acc_period.nb +(acc_new.nb+acc_end.nb)/2) ELSE 0 END as churn FROM acc_new ,acc_end,acc_period', 1, 1, false);]]>
        </sql>
        <sql>
            <![CDATA[INSERT INTO dwh_measurable_quant (id, version, disabled, created, updated, code, description, dimension_1, dimension_2, dimension_3, dimension_4, editable, measurement_period, sql_query, provider_id, creator_id, additive) VALUES (nextval('dwh_measurable_quant_seq'), 0, false, '2016-09-09 09:36:00.00', '2016-09-09 09:36:00.00', 'MRR2', 'MRR', 'Offer', 'BA', 'CA', 'Cust', false, 'MONTHLY', '	SELECT  wo.amount_without_tax/((EXTRACT(epoch FROM (wo.end_date - wo.start_date))/86400)) as mrr_value, wo.offer_code as offer_code,ba.code as ba_code,ca.code as ca_code,cust.code as cust_code FROM billing_wallet_operation wo LEFT JOIN crm_provider p ON p.id=wo.provider_id LEFT JOIN billing_charge_instance ci ON ci.id=wo.charge_instance_id LEFT JOIN billing_subscription sub ON sub.id = ci.subscription_id LEFT JOIN billing_wallet w ON w.id=wo.wallet_id LEFT JOIN billing_user_account uaa ON uaa.id= w.user_account_id LEFT JOIN account_entity ua ON ua.id= uaa.id LEFT JOIN billing_billing_account baa ON baa.id= uaa.billing_account_id LEFT JOIN account_entity ba ON ba.id= baa.id LEFT JOIN ar_customer_account caa ON caa.id= baa.customer_account_id LEFT JOIN account_entity ca ON ca.id= caa.id LEFT JOIN crm_customer custa ON custa.id= caa.customer_id LEFT JOIN account_entity cust ON cust.id= custa.id WHERE wo.disabled=FALSE AND wo.provider_id=#{provider} AND NOT(wo.end_date IS NULL) AND ((EXTRACT(epoch FROM (wo.end_date - wo.start_date))/86400))>0 AND (wo.start_date <= "#{date}") AND (wo.end_date > "#{date}")', 1, 1, false);]]>
        </sql>
    </changeSet>

	<changeSet id="#1849_20160909" author="EdwardPLegaspi">
		<sql><![CDATA[DELETE FROM dwh_measurable_quant WHERE code IN ('MRR2', 'CHURN2');]]></sql>

		<insert tableName="meveo_timer">
			<column name="id" valueSequenceNext="meveo_timer_seq" />
			<column name="version" valueNumeric="0" />
			<column name="sc_d_o_month" value="Last" />
			<column name="sc_d_o_week" value="0" />
			<column name="sc_hour" value="23" />
			<column name="sc_min" value="59" />
			<column name="sc_month" value="*" />
			<column name="sc_sec" value="59" />
			<column name="sc_year" value="*" />
			<column name="provider_id" valueNumeric="1" />
			<column name="code" value="Monthly" />
			<column name="disabled" valueBoolean="false" />
			<column name="created" valueDate="2015-03-19 00:04:19.913" />
		</insert>

		<insert tableName="meveo_job_instance">
			<column name="id" valueSequenceNext="meveo_job_instance_seq" />
			<column name="version" valueNumeric="0" />
			<column name="disabled" valueBoolean="false" />
			<column name="created" valueDate="2016-09-14 00:00:00.000" />
			<column name="job_category" value="DWH" />
			<column name="job_template" value="DWHQueryJob" />
			<column name="code" value="DWH_Job_MRR" />
			<column name="provider_id" valueNumeric="1" />
			<column name="creator_id" valueNumeric="1" />
			<column name="timerentity_id" valueNumeric="2" />
			<column name="UUID" value="DWH_Job_MRR" />
			<column name="parametres" value="MRR"></column>
		</insert>

		<insert tableName="meveo_job_instance">
			<column name="id" valueSequenceNext="meveo_job_instance_seq" />
			<column name="version" valueNumeric="0" />
			<column name="disabled" valueBoolean="false" />
			<column name="created" valueDate="2016-09-14 00:00:00.000" />
			<column name="job_category" value="DWH" />
			<column name="job_template" value="DWHQueryJob" />
			<column name="code" value="DWH_Job_CHURN" />
			<column name="provider_id" valueNumeric="1" />
			<column name="creator_id" valueNumeric="1" />
			<column name="timerentity_id" valueNumeric="2" />
			<column name="UUID" value="DWH_Job_CHURN" />
			<column name="parametres" value="CHURN"></column>
		</insert>
	</changeSet>

</databaseChangeLog>