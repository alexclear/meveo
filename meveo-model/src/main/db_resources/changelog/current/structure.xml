<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

	<changeSet id="ticket703_20150429" author="Mbarek"> 
     <modifyDataType tableName="billing_invoice" columnName="invoice_number" newDataType="VARCHAR(50)"/>
   </changeSet>
	<changeSet id="ticket599_20150429" author="Mbarek">
	<addColumn tableName="AR_CUSTOMER_ACCOUNT">
	<column name="TRADING_LANGUAGE_ID" type="BIGINT"/>
	</addColumn>
	</changeSet>

	<changeSet id="ticket685_20150430" author="EdwardLegaspi">
		<validCheckSum>7:668fdc1cfd06732a26ba11882dbd29fc</validCheckSum>
	
		<addColumn tableName="billing_wallet_operation">
			<column name="input_quantity" type="numeric(23, 12)" />
			<column name="input_unit_description" type="varchar(20)" />
			<column name="rating_unit_description" type="varchar(20)" />
		</addColumn>
		
		<sql>UPDATE billing_wallet_operation set rating_unit_description=unity_description;</sql>
		
		<dropColumn columnName="unity_description" tableName="billing_wallet_operation" />

		<addColumn tableName="cat_charge_template">
			<column name="input_unit_description" type="varchar(20)" />
			<column name="rating_unit_description" type="varchar(20)" />
			<column name="unit_multiplicator" type="numeric(23, 12)" />
			<column name="unit_nb_decimal" type="int4" />
		</addColumn>
		
		<addColumn tableName="billing_usage_charge_inst">
			<column name="rating_unit_description" type="varchar(20)" />
		</addColumn>
		
		<sql>UPDATE cat_charge_template a SET rating_unit_description=(SELECT b.unity_description from cat_usage_charge_template b where b.id=a.id);</sql>
		<sql>UPDATE billing_usage_charge_inst set rating_unit_description=unity_description;</sql>

		<dropColumn columnName="unity_description" tableName="cat_usage_charge_template" />
		<dropColumn columnName="unity_multiplicator" tableName="cat_usage_charge_template" />
		<dropColumn columnName="unity_nb_decimal" tableName="cat_usage_charge_template" />
		<dropColumn columnName="unity_formatter" tableName="cat_usage_charge_template" />

		<dropColumn columnName="unity_description" tableName="billing_usage_charge_inst" />
	</changeSet>
	<changeSet id="ticket685_20150430" author="AndriusKarpavicius">
		<sql>update cat_charge_template set unit_nb_decimal=0 where unit_nb_decimal is null</sql>
	</changeSet>	
	
	<changeSet id="ticket646_20150506" author="SebastienMichea">
		<addColumn tableName="cat_wallet_template">
			<column name="low_balance_level" type="numeric(23, 12)" />
		</addColumn>
		<addColumn tableName="billing_wallet">
			<column name="low_balance_level" type="numeric(23, 12)" />
		</addColumn>
	</changeSet>
	
	<changeSet id="ticket684_20150507" author="EdwardLegaspi">
		<createTable tableName="billing_invoice_configuration">
			<column name="id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="version" type="INT4" />
			<column name="provider_id" type="BIGINT" />
			<column name="display_subscriptions" type="BOOL" />
			<column name="display_services" type="BOOL" />
			<column name="display_offers" type="BOOL" />
		</createTable>
		
		<createSequence sequenceName="billing_invoice_configuration_seq" startValue="2"/>

		<addForeignKeyConstraint constraintName="provider_invoice_configuration_fk"
			referencedTableName="crm_provider" baseColumnNames="provider_id"
			baseTableName="billing_invoice_configuration" referencedColumnNames="id"
			onDelete="CASCADE" onUpdate="CASCADE" />
	</changeSet>
	<changeSet id="ticket684_20150507-update" author="EdwardLegaspi-AndriusKarpavicius">
		<delete tableName="billing_invoice_configuration"/>
		<addColumn tableName="billing_invoice_configuration">
			<column name="disabled" type="BOOL">
				<constraints nullable="false" />
			</column>
			<column name="created" type="TIMESTAMP WITHOUT TIME ZONE">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="TIMESTAMP WITHOUT TIME ZONE" />
			<column name="creator_id" type="BIGINT" />
			<column name="updater_id" type="BIGINT" />
			<column name="code" type="VARCHAR(60)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="VARCHAR(100)" />
		</addColumn>
		<addPrimaryKey columnNames="id" constraintName="billing_invoice_configuration_pkey" tableName="billing_invoice_configuration" />
		<addForeignKeyConstraint baseColumnNames="creator_id" baseTableName="billing_invoice_configuration" constraintName="fk_invoice_configuration_creator"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
		<addForeignKeyConstraint baseColumnNames="updater_id" baseTableName="billing_invoice_configuration" constraintName="fk_invoice_configuration_updater"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />
	</changeSet>	
	<changeSet id="ticket599_20150507" author="Mbarek">
		<sql>update ar_customer_account set trading_language_id=(select trading_language_id from billing_billing_account  where billing_billing_account.customer_account_id=ar_customer_account.id ORDER BY billing_billing_account.id ASC LIMIT 1)</sql>
	</changeSet>
</databaseChangeLog>
